<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>WelearnBrainBurst | GamerNoTitle</title>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            -webkit-text-size-adjust: none;
        }

        :not(:defined) {
            display: none;
        }

        .status-card {
            margin: 16px;
            padding: 16px;
            background: var(--md-sys-color-surface-container);
            border-radius: 12px;
        }
    </style>
    <link rel="stylesheet" href="/static/css/sober-theme.css">
    <link rel="stylesheet" href="/static/css/toastify.css">
    <link rel="icon" href="/static/img/Nega_Nebulus_Logo.png">
</head>

<body>
    <s-page theme="auto">
        <!-- ä¾§è¾¹å¯¼èˆª -->
        <s-drawer>
            <div slot="start" style="width: auto;">
                <s-navigation mode="rail" onchange="handleNavChange(event)">
                    <s-icon-button slot="start" type="filled-tonal">
                        <img src="/static/img/Nega_Nebulus_Logo.png" alt="Logo" style="width: 40px; height: 40px;">
                    </s-icon-button>

                    <s-navigation-item selected="true">
                        <svg slot="icon" viewBox="0 -960 960 960">
                            <path
                                d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />
                        </svg>
                        <div slot="text">æ§åˆ¶é¢æ¿</div>
                    </s-navigation-item>

                    <div slot="end" style="display: flex;align-items: flex-end; padding: 16px 0;">
                        <s-dialog>
                            <s-icon-button type="outlined" slot="trigger">
                                <svg viewBox="0 -960 960 960">
                                    <path
                                        d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z">
                                    </path>
                                </svg>
                            </s-icon-button>
                            <div slot="headline">å…³äº</div>
                            <div slot="text">
                                <h4>WelearnBrainBurst</h4>
                                <p>
                                    WelearnBrainBurst æ˜¯ä¸€ä¸ª WELearn åŠ©æ‰‹ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·è½»æ¾åœ°ä½¿ç”¨ WELearnï¼ŒåŒæ—¶æä¾›ä¸€äº›<b>é¢å¤–</b>çš„å®ç”¨åŠŸèƒ½ã€‚
                                </p>
                                <h4>ä¸ºä»€ä¹ˆå« WelearnBrainBurst</h4>
                                <p>
                                    åœ¨åšè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œå°±åœ¨æƒ³åå­—è¦å–ä»€ä¹ˆï¼Œç„¶åæƒ³åˆ°äº†ä»¥å‰çœ‹è¿‡çš„ç•ªã€ŠåŠ é€Ÿä¸–ç•Œã€‹ï¼Œé‡Œé¢åŠ å…¥ Burst Link çš„å£ä»¤å°±æ˜¯ Brain
                                    Burstï¼Œå°±æ‹¿è¿‡æ¥ç”¨äº†ï¼ˆè¯è¯´è¿˜æœ‰äººè®°å¾—åŠ é€Ÿä¸–ç•Œå˜›ï¼‰
                                </p>
                                <h4>å…è´£å£°æ˜</h4>
                                <p>
                                    æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚
                                </p>
                                <s-divider></s-divider>
                                <p><a href="https://github.com/GDUTMeow/WelearnBrainBurst">https://github.com/GDUTMeow/WelearnBrainBurst</a></p>
                                <p>
                                    Â© <span id="copyrightYear"></span>
                                    <a href="https://github.com/GamerNoTitle">GamerNoTitle</a>. åªæˆæƒä¸ªäººä½¿ç”¨ï¼Œç¦æ­¢è¿›è¡Œå•†ä¸šç”¨é€”ã€‚
                                </p>
                            </div>
                            <s-button type="text" slot="action"> å…³é—­ </s-button>
                        </s-dialog>
                    </div>

                </s-navigation>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <s-appbar>
                <s-icon-button slot="navigation" onclick="document.querySelector('s-drawer').toggle()">
                    <s-icon name="menu"></s-icon>
                </s-icon-button>
                <div slot="headline">WelearnBrainBurst</div>
            </s-appbar>

            <s-linear-progress indeterminate="true" id="loading" style="display: none;"></s-linear-progress>

            <!-- æ§åˆ¶é¢æ¿ -->
            <s-scroll-view id="allView">
                <main style="display: block; margin: 24px; margin-left: 15%; max-width: 70%;">
                    <s-card style="display: block;
                    padding: 24px;
                    width: 100%;
                    max-width: 100%;
                    margin-top: 24px;">
                        <div slot="headline">è´¦å·ç®¡ç†</div>
                        <div slot="text">
                            <p>ä½¿ç”¨æ–¹æ³•ï¼š<a href="https://gamernotitle.sg.larksuite.com/wiki/PLLywJxlViN31tkBiIflSaytgBg">https://gamernotitle.sg.larksuite.com/wiki/PLLywJxlViN31tkBiIflSaytgBg</a></p>
                            <s-text-field style="display: grid; width: auto; margin-bottom: 24px; margin-top: 24px;"
                                label="Cookie" name="cookie-input" id="cookie-input"></s-text-field>
                            <div align="right">
                                <p id="lastModified">ä¸Šæ¬¡ä¿å­˜ï¼šæœªçŸ¥</p>
                                <p id="onlineStatus">åœ¨çº¿çŠ¶æ€</p>
                                <s-button id="save-cookie-btn">ä¿å­˜ Cookie å¹¶ç™»å½•</s-button>
                            </div>
                            <div align="right" style="margin-top: 8px;">
                                <s-button id="reset-btn" style="margin-right: 8px;">é‡ç½®ç¨‹åºçŠ¶æ€</s-button>
                                <s-snackbar>å·²å‘å‡ºå…³é—­æŒ‡ä»¤ï¼Œç°åœ¨å¯ä»¥å…³é—­æœ¬é¡µé¢äº†
                                    <s-button id="shutdown" slot="trigger">é€€å‡ºç¨‹åº</s-button>
                                </s-snackbar>
                            </div>
                        </div>
                        <s-divider style="margin-top: 24px; margin-bottom: 24px"> ä»»åŠ¡çŠ¶æ€ </s-divider>
                        <div style="padding-left: 24px;">
                            <h2>ä»»åŠ¡çŠ¶æ€</h2>
                            <h3 id="current-status">âšª æœªçŸ¥ (unknown)</h3>
                            <h4 id="progress-text"></h4>
                            <s-linear-progress indeterminate="true" id="indetermined-status"
                                style="margin-top: 16px; margin-bottom: 16px;"></s-linear-progress>
                            <s-linear-progress id="task-status" animated="true"
                                style="margin-top: 16px; margin-bottom: 16px;" value="0"></s-linear-progress>
                        </div>

                    </s-card>

                    <s-card style="display: none;
                    padding: 24px;
                    width: 100%;
                    max-width: 100%;
                    margin-top: 24px;" id="dashboard">
                        <div slot="headline" id="welcomeMessage"></div>
                        <div slot="text">
                            <s-table
                                style="max-width: 100%; width: 100%; margin-top: 24px; margin-bottom: 24px; text-align: center;">
                                <s-thead>
                                    <s-tr>
                                        <s-th>è¯¾ç¨‹ç¼–å·</s-th>
                                        <s-th>è¯¾ç¨‹åç§°</s-th>
                                        <s-th>å®Œæˆè¿›åº¦</s-th>
                                        <s-th>æ“ä½œ</s-th>
                                    </s-tr>
                                </s-thead>
                                <s-tbody id="course-list">
                                    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
                                </s-tbody>
                            </s-table>
                            <div id="course-list-container" style="display: none;">
                                <s-divider> å•å…ƒåˆ—è¡¨ </s-divider>
                                <s-table
                                    style="max-width: 100%; width: 100%; margin-top: 24px; margin-bottom: 24px; text-align: center;">
                                    <s-thead>
                                        <s-tr>
                                            <s-th>å•å…ƒç¼–å·</s-th>
                                            <s-th>è¯¾ç¨‹åç§°</s-th>
                                            <s-th>å¼€æ”¾çŠ¶æ€</s-th>
                                            <s-th>é€‰æ‹©</s-th>
                                            <s-th>å±•å¼€å°èŠ‚</s-th>
                                        </s-tr>
                                    </s-thead>
                                    <s-tbody id="lesson-list">
                                        <!-- å•å…ƒåˆ—è¡¨ -->
                                    </s-tbody>
                                </s-table>
                                <div id="section-list-container" style="display:none; margin-top:16px;">
                                    <s-divider> å°èŠ‚åˆ—è¡¨ <span id="section-list-title"></span> </s-divider>
                                    <s-table style="max-width: 100%; width: 100%; margin-top: 16px; margin-bottom: 24px; text-align: center;">
                                        <s-thead>
                                            <s-tr>
                                                <s-th>å°èŠ‚ID</s-th>
                                                <s-th>åç§°</s-th>
                                                <s-th>çŠ¶æ€</s-th>
                                                <s-th>
                                                    é€‰æ‹©
                                                    <s-checkbox id="section-select-all">å…¨é€‰</s-checkbox>
                                                </s-th>
                                            </s-tr>
                                        </s-thead>
                                        <s-tbody id="section-list"></s-tbody>
                                    </s-table>
                                </div>
                            </div>
                            <div id='params-setup' style="display: none;">
                                <s-divider> è¯¾ç¨‹å‚æ•°è®¾ç½® </s-divider>
                                <s-text-field style="display: grid; width: auto; margin-top: 24px; margin-bottom: 12px;"
                                    label="æ­£ç¡®ç‡" id="correct-rate"></s-text-field>
                                <s-text-field style="display: grid; width: auto; margin-top: 12px; margin-bottom: 24px;"
                                    label="å°èŠ‚é”™å¼€" id="section-offset"></s-text-field>
                                <s-text-field style="display: grid; width: auto; margin-top: 24px; margin-bottom: 24px;"
                                    label="æŒ‚æœºæ—¶é—´" id="idle-time"></s-text-field>
                                <div align="center">
                                    <p>æ­£ç¡®ç‡è¡¨ç¤ºå•å…ƒçš„æ¯ä¸€èŠ‚çš„æ­£ç¡®ç‡åº”è¯¥ä¸ºå¤šå°‘ï¼Œå¯ä»¥æ˜¯ç¡®åˆ‡çš„æ•°å€¼ä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼Œä¾‹å¦‚ 98 è¡¨ç¤º 98% æ­£ç¡®ç‡ï¼Œ98-100 è¡¨ç¤º 98%-100% æ­£ç¡®ç‡ä¹‹é—´éšæœº
                                    </p>
                                    <p>å°èŠ‚é”™å¼€æŒ‡æ¯ä¸ªå°èŠ‚ä¹‹é—´åº”è¯¥é”™å¼€å¤šä¹…å®Œæˆï¼Œå¯ä»¥å¡«å›ºå®šå€¼ä¹Ÿå¯ä»¥å¡«èŒƒå›´ï¼Œä¾‹å¦‚ 20 è¡¨ç¤ºæ¯ä¸€å°èŠ‚éƒ½é”™å¼€ 20 ç§’ï¼Œ20-60 è¡¨ç¤ºæ¯ä¸€å°èŠ‚ä¹‹é—´é”™å¼€ 20 ç§’åˆ° 60 ç§’é—´çš„ä¸€ä¸ªéšæœºå€¼</p>
                                    <p>æŒ‚æœºæ—¶é—´è¡¨ç¤ºå•å…ƒçš„æ¯ä¸€èŠ‚è¦æŒ‚æœºå¤šä¹…ï¼Œå¯ä»¥æ˜¯ç¡®åˆ‡çš„æ•°å€¼ä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼Œä¾‹å¦‚ 300 è¡¨ç¤ºæ¯ä¸€èŠ‚éƒ½æŒ‚æœº 5 åˆ†é’Ÿï¼Œ180-300 è¡¨ç¤ºæ¯ä¸€èŠ‚æŒ‚æœº 180 ç§’åˆ° 300
                                        ç§’ä¸ç­‰çš„æ—¶é—´</p>
                                </div>
                                <div align="left">
                                    <s-alert id="selection-summary" style="margin-bottom: 12px; text-align: left; color: var(--md-sys-color-on-surface-variant); width: 100%;"></s-alert>
                                </div>
                                <div align="right" style="margin-top: 24px;">
                                    <br>
                                    <s-checkbox id="freeToUse">
                                        <b>æˆ‘åŒæ„ï¼šæœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿ</b>
                                    </s-checkbox>
                                    <br>
                                    <s-checkbox id="disclaimer">
                                        <b>æˆ‘åŒæ„ï¼šä½¿ç”¨æœ¬é¡¹ç›®é€ æˆçš„åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ï¼Œä½œè€…ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»</b>
                                    </s-checkbox>
                                    <br>
                                    <s-button id="start-brain-burst" slot="trigger">å¼€å§‹åˆ·è¯¾ï¼</s-button>
                                    <s-button id="start-away-from-keyboard" slot="trigger">
                                        å¼€å§‹æŒ‚æœºï¼
                                    </s-button>
                                </div>
                            </div>
                        </div>
                    </s-card>
                </main>
            </s-scroll-view>
        </s-drawer>
    </s-page>

    <script src="/static/js/sober.min.js"></script>
    <script src="/static/js/toastify.js"></script>
    <script>
        let autoRefreshInterval = null;
    let selectedlessons = new Set(); // å­˜å‚¨é€‰ä¸­çš„å•å…ƒID
    const selectedSections = new Map(); // Map<unitId, Set<sectionId>>
    const sectionsByUnit = new Map(); // Map<unitId, Map<sectionId, {id,name}>>
    const unitMeta = new Map(); // Map<unitId, {unitname,name,visible}>
        let shutdownFlag = false;

        // å…œåº•ï¼šå¦‚æœ showToast æœªæ³¨å…¥ï¼Œåˆ™æä¾›ä¸€ä¸ªç®€å•çš„æ§åˆ¶å°å›é€€
        window.showToast = window.showToast || function (message, type = 'info') {
            try {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: 'bottom',
                    position: 'right',
                    style: {
                        background: type === 'error'
                            ? 'linear-gradient(to right, #fb7185, #ef4444)'
                            : (type === 'success'
                                ? 'linear-gradient(to right, #34d399, #22d3ee)'
                                : 'linear-gradient(to right, #6366f1, #3b82f6)'),
                        borderRadius: '16px',
                    },
                    stopOnFocus: true,
                }).showToast();
            } catch (e) {
                console.log(`[${type}] ${message}`);
            }
        }

        function clearAllUnitSelections() {
            selectedlessons.clear();
            document.querySelectorAll('#lesson-list s-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }

        function clearAllSectionSelections() {
            selectedSections.clear();
            document.querySelectorAll('#section-list .section-checkbox').forEach(cb => {
                cb.checked = false;
            });
            const headerAll = document.getElementById('section-select-all');
            if (headerAll) headerAll.checked = false;
        }

        function updateSelectionSummary() {
            const summary = document.getElementById('selection-summary');
            if (!summary) return;
            // æ˜¯å¦é€‰æ‹©äº†å°èŠ‚
            let hasSection = false;
            const parts = [];
            const unitSummaries = [];
            let totalSelected = 0;
            selectedSections.forEach((set, unitId) => {
                if (set.size > 0) {
                    hasSection = true;
                    totalSelected += set.size;
                    const secMap = sectionsByUnit.get(unitId) || new Map();
                    const um = unitMeta.get(unitId) || {};
                    const unitLabel = [um.unitname, um.name].filter(Boolean).join(' - ') || unitId;
                    const items = Array.from(set).map(secId => {
                        const meta = secMap.get(secId);
                        const label = meta && meta.name ? meta.name : secId;
                        return `<li>${label} <span style="opacity:.7">(${secId})</span></li>`;
                    }).join('');
                    unitSummaries.push(`
                        <div style="margin-top:6px;">
                            <b>å•å…ƒï¼š${unitLabel}</b>ï¼ˆæ•°é‡ï¼š${set.size}ï¼‰
                            <ul style="margin:6px 0 0 18px;">${items}</ul>
                        </div>
                    `);
                }
            });
            if (hasSection) {
                parts.push(`<div>å·²é€‰æ‹©ç±»å‹ï¼šå°èŠ‚ï¼ˆæ€»æ•°é‡ï¼š${totalSelected}ï¼‰</div>`);
                parts.push(unitSummaries.join(''));
                summary.innerHTML = parts.join('');
                return;
            }
            // é€€è€Œåˆ¤æ–­å•å…ƒï¼šåˆ—å‡ºæ¯ä¸ªé€‰ä¸­å•å…ƒ
            if (selectedlessons.size > 0) {
                const items = Array.from(selectedlessons).map(uid => {
                    const meta = unitMeta.get(uid) || {};
                    const labelParts = [];
                    if (meta.unitname) labelParts.push(meta.unitname);
                    if (meta.name) labelParts.push(meta.name);
                    const label = labelParts.join(' - ') || uid;
                    return `<li>${label} <span style="opacity:.7">(${uid})</span></li>`;
                }).join('');
                summary.innerHTML = `å·²é€‰æ‹©ç±»å‹ï¼šå•å…ƒï¼ˆæ•°é‡ï¼š${selectedlessons.size}ï¼‰<ul style="margin:6px 0 0 18px;">${items}</ul>`;
            } else {
                summary.innerHTML = 'å°šæœªé€‰æ‹©å•å…ƒæˆ–å°èŠ‚';
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ·»åŠ /ç§»é™¤å•å…ƒID
        function addlesson(lessonId) {
            const checkbox = document.querySelector(`s-checkbox[onchange*="${lessonId}"]`);
            if (checkbox.checked) {
                // è‹¥æ­¤å‰å·²é€‰æ‹©äº†å°èŠ‚ï¼Œåˆ™åˆ‡æ¢ä¸ºâ€œæŒ‰å•å…ƒâ€æ¨¡å¼ï¼Œæ¸…ç©ºå°èŠ‚é€‰æ‹©
                let hasSections = false;
                selectedSections.forEach(set => { if (set.size > 0) hasSections = true; });
                if (hasSections) {
                    clearAllSectionSelections();
                    showToast('å·²åˆ‡æ¢ä¸ºã€Œå•å…ƒã€æ¨¡å¼ï¼šå·²æ¸…é™¤å·²é€‰å°èŠ‚');
                }
                selectedlessons.add(lessonId);
            } else {
                selectedlessons.delete(lessonId);
            }
            updateSelectionSummary();
        }

        // éªŒè¯æ­£ç¡®ç‡æ ¼å¼ï¼ˆ0-100 æˆ– A-Bï¼‰
        function validateRate(input) {
            if (/^\d+$/.test(input)) {
                const num = parseInt(input);
                return num >= 0 && num <= 100;
            }
            if (/^\d+-\d+$/.test(input)) {
                const [a, b] = input.split('-').map(Number);
                return a >= 0 && b <= 100 && a < b;
            }
            return false;
        }

        // éªŒè¯æ—¶é—´æ ¼å¼ï¼ˆæ­£æ•´æ•°æˆ– A-Bï¼‰
        function validateTime(input) {
            if (/^\d+$/.test(input)) {
                return parseInt(input) > 0;
            }
            if (/^\d+-\d+$/.test(input)) {
                const [a, b] = input.split('-').map(Number);
                return a > 0 && b > 0 && a < b;
            }
            return false;
        }

        // é¡µé¢å¯¼èˆªå¤„ç†
        function handleNavChange(event) {
            const pages = ['dashboard', 'courses', 'settings'];
            pages.forEach(page => {
                document.getElementById(page).style.display =
                    event.target.selectedIndex === pages.indexOf(page) ? 'block' : 'none';
            });
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const { success, status, progress } = await res.json();

                if (success) {
                    document.getElementById('current-status').textContent = status;
                    if (status === 'idle' || status === 'error' || status === 'nologon') {
                        document.getElementById('indetermined-status').style.display = 'block';
                        document.getElementById('task-status').style.display = 'none';
                        if (status === 'nologon') {
                            document.getElementById('current-status').textContent = 'ğŸ”´ æœªç™»å½• (nologon)';
                            document.getElementById('progress-text').textContent = 'å½“å‰è¿è¡ŒçŠ¶æ€ï¼šè¯·å…ˆç™»å½•';
                        } else if (status === 'idle') {
                            document.getElementById('current-status').textContent = 'ğŸŸ¢ æ­£åœ¨å¾…æœº (idle)';
                            document.getElementById('progress-text').textContent = 'å½“å‰è¿è¡ŒçŠ¶æ€ï¼šæ­£åœ¨å¾…æœºï¼Œç­‰å¾…ä»»åŠ¡';
                        } else if (status === 'error') {
                            document.getElementById('current-status').textContent = 'ğŸ”´ é”™è¯¯ (error)';
                            document.getElementById('progress-text').textContent = 'å½“å‰è¿è¡ŒçŠ¶æ€ï¼šå‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—';
                        }
                    }
                    else {
                        if (status === 'brain_burst') {
                            document.getElementById('current-status').textContent = 'ğŸŸ¡ æ­£åœ¨åˆ·è¯¾ (brain_burst)';
                            document.getElementById('progress-text').textContent = `å½“å‰è¿è¡ŒçŠ¶æ€ï¼šæ­£åœ¨åˆ·è¯¾ï¼Œå®Œæˆæƒ…å†µ ${progress.current}/${progress.total} (${(progress.current / progress.total * 100).toFixed(2)}%)`;
                        } else if (status === 'away_from_keyboard') {
                            document.getElementById('current-status').textContent = 'ğŸŸ¡ æ­£åœ¨æŒ‚æœº (away_from_keyboard)'
                            document.getElementById('progress-text').textContent = `å½“å‰è¿è¡ŒçŠ¶æ€ï¼šæ­£åœ¨æŒ‚æœºï¼Œå®Œæˆæƒ…å†µ ${progress.current}/${progress.total} (${(progress.current / progress.total * 100).toFixed(2)}%)`;
                        } else if (status === 'completed') {
                            document.getElementById('current-status').textContent = 'ğŸŸ¢ å·²å®Œæˆ (completed)';
                            document.getElementById('progress-text').textContent = `å½“å‰è¿è¡ŒçŠ¶æ€ï¼šå·²å®Œæˆï¼Œå®Œæˆæƒ…å†µ ${progress.current}/${progress.total} (${(progress.current / progress.total * 100).toFixed(2)}%)`;
                        }
                        document.getElementById('indetermined-status').style.display = 'none';
                        document.getElementById('task-status').style.display = 'block';
                        document.getElementById('task-status').value = progress.current / progress.total * 100;
                    }
                    document.getElementById('task-progress').value =
                        progress.total > 0 ? (progress.current / progress.total) * 100 : 0;
                    document.getElementById('progress-text').textContent =
                        `${progress.current}/${progress.total}`;
                }
            } catch (error) {
                console.warn('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }

        // è·å–æ—¥å¿—
        async function fetchLogs() {
            const res = await fetch('/api/getLog');
            const { logs } = await res.json();
            const logOutput = document.getElementById('log-output');
            logOutput.textContent = logs;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // å¼€å§‹ä»»åŠ¡
        async function startTask(taskType) {
            const res = await fetch(`/api/${taskType}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ /* å‚æ•° */ })
            });

            if (res.ok) {
                if (!autoRefreshInterval) {
                    autoRefreshInterval = setInterval(async () => {
                        await updateStatus();
                        await fetchLogs();
                    }, 2000);
                }
            }
        }

        // åœæ­¢ä»»åŠ¡
        async function stopTasks() {
            await fetch('/api/stop', { method: 'POST' });
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            await updateStatus();
        }

        // è¯¾ç¨‹åŠ è½½
        async function loadCourses() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch('/api/getCourses');
                const data = await res.json(); // å¿…é¡»åŠ  await
                console.log('æ¥å£å“åº”æ•°æ®:', data); // è°ƒè¯•ç”¨

                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data.courses) {
                    throw new Error("æ¥å£æœªè¿”å› courses å­—æ®µ");
                }

                const { courses, cid, classid, uid } = data;
                const tbody = document.getElementById('course-list');
                // åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ
                tbody.innerHTML = courses.map(course => `
            <s-tr>
                <s-td>${course.cid}</s-td>
                <s-td>${course.name}</s-td>
                <s-td>
                    ${course.per}% 
                    <s-linear-progress 
                        animated="true" 
                        ${course.per ? `value="${course.per}"` : 'indeterminate="true"'}
                    ></s-linear-progress>
                </s-td>
                <s-td>
                    <s-button 
                        type="filled-tonal" 
                        class="course-select-btn" 
                        data-course-id="${course.cid}"
                    >é€‰æ‹©</s-button>
                </s-td>
            </s-tr>
        `).join('');

            } catch (error) {
                console.warn('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
            }
            document.getElementById('loading').style.display = 'none';
        }
        // Cookieæ“ä½œ
        async function saveCookie() {
            const cookie = document.getElementById('cookie-input').value;
            document.getElementById('loading').style.display = 'block';
            localStorage.setItem('cookie', cookie);
            localStorage.setItem('lastModified', new Date().toLocaleString());
            document.getElementById('lastModified').textContent = `ä¸Šæ¬¡ä¿å­˜ï¼š${localStorage.getItem('lastModified')}`;
            const loginRes = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cookies: cookie })
            });
            try {
                const data = await loginRes.json();
                if (data && data.success) {
                    showToast('ç™»å½•æˆåŠŸ', 'success');
                    // æ ‡è®°æœ¬æ¬¡ä¸ºæ‰‹åŠ¨ç™»å½•ï¼Œé¿å…è§¦å‘è‡ªåŠ¨ç™»å½•æç¤º
                    sessionStorage.setItem('manualLoginJustNow', '1');
                } else {
                    showToast(`ç™»å½•å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) { /* ignore */ }
            document.getElementById('loading').style.display = 'none';
            if (checkLogon()) {
                loadCourses();
            }

        }

        function displayCookieAndLastModified() {
            const cookie = localStorage.getItem('cookie');
            const lastModified = localStorage.getItem('lastModified');
            if (cookie) {
                document.getElementById('cookie-input').value = cookie;
            }
            if (lastModified) {
                document.getElementById('lastModified').textContent = `ä¸Šæ¬¡ä¿å­˜ï¼š${lastModified}`;
            }
        }

        async function getCurrentStatus() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                return {
                    status: data.status,
                    progress: {
                        current: data.progress?.current || 0,
                        total: data.progress?.total || 0
                    },
                    activeThreads: data.activeThreads || 0
                };
            } catch (error) {
                console.warn('è·å–çŠ¶æ€å¤±è´¥:', error);
                return { status: 'error' }; // è¿”å›æ˜ç¡®çš„é”™è¯¯çŠ¶æ€
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function checkLogon() {
            try {
                const currentStatus = await getCurrentStatus(); // ä½¿ç”¨ await è§£æ Promise
                console.log('å½“å‰çŠ¶æ€:', currentStatus);

                if (currentStatus.status !== 'nologon') {
                    document.getElementById('dashboard').style.display = 'block';
                    const userRes = await fetch('/api/getUserInfo');
                    const userData = await userRes.json();

                    document.getElementById('welcomeMessage').textContent =
                        `æ¬¢è¿å›æ¥ï¼Œ${userData.name} (${userData.student_id})ï¼`;
                    document.getElementById('onlineStatus').textContent =
                        'åœ¨çº¿çŠ¶æ€ï¼šğŸŸ¢ å·²ç™»å½•';
                    // é¡µé¢åŠ è½½åçš„è‡ªåŠ¨ç™»å½•æˆåŠŸæç¤ºï¼ˆä»…æç¤ºä¸€æ¬¡ï¼‰ï¼Œæ‰‹åŠ¨ç™»å½•ä¸æç¤º
                    const manual = sessionStorage.getItem('manualLoginJustNow');
                    if (!manual) {
                        const autoLoginToasted = sessionStorage.getItem('autoLoginToasted');
                        if (!autoLoginToasted) {
                            showToast('è‡ªåŠ¨ç™»å½•æˆåŠŸ', 'success');
                            sessionStorage.setItem('autoLoginToasted', '1');
                        }
                    } else {
                        // æ¸…ç†æ‰‹åŠ¨ç™»å½•æ ‡è®°ï¼Œé¿å…ä¸‹æ¬¡è¯¯åˆ¤
                        sessionStorage.removeItem('manualLoginJustNow');
                    }
                    return true;
                } else {
                    document.getElementById('dashboard').style.display = 'none';
                    document.getElementById('onlineStatus').textContent =
                        'åœ¨çº¿çŠ¶æ€ï¼šğŸ”´ æœªç™»å½•';
                    return false;
                }
            } catch (error) {
                console.warn('ç™»å½•æ£€æŸ¥å¤±è´¥:', error);
                document.getElementById('onlineStatus').textContent =
                    'åœ¨çº¿çŠ¶æ€ï¼šâšª æ£€æµ‹å¼‚å¸¸ï¼ˆè¯·æ£€æŸ¥æ§åˆ¶å°ï¼‰';
                return false;
            }
        }
                async function selectCourse(cid) {
            document.getElementById('loading').style.display = 'block';
            await fetch('/api/getLessons?cid=' + cid)
                .then(res => res.json())
                .then(data => {
                    console.log(data)
                    const tbody = document.getElementById('lesson-list');
                    selectedlessons.clear();
                                        // è®°å½•å•å…ƒå…ƒæ•°æ®ä¾›æ‘˜è¦ä½¿ç”¨
                                        unitMeta.clear();
                                        (data.lessons || []).forEach(lesson => {
                                                unitMeta.set(lesson.id, { unitname: lesson.unitname, name: lesson.name, visible: lesson.visible });
                                        });
                    tbody.innerHTML = data.lessons.map(lesson => `
        <s-tr>
          <s-td>${lesson.id}</s-td>
          <s-td>${lesson.name}</s-td>
          <s-td>${lesson.visible ? "å·²å¼€æ”¾" : "æœªå¼€æ”¾"}</s-td>
          <s-td>
            <s-checkbox onchange=addlesson("${lesson.id}")>æˆ‘è¦åˆ·è¿™ä¸ªå•å…ƒï¼</s-checkbox>
          </s-td>
          <s-td>
            <s-button class="expand-sections-btn" data-unit-id="${lesson.id}">å±•å¼€å°èŠ‚</s-button>
          </s-td>
        </s-tr>
                    `).join('');
                });
            document.getElementById('loading').style.display = 'none';
            document.getElementById('course-list-container').style.display = 'block';
            document.getElementById('params-setup').style.display = 'block';
                        updateSelectionSummary();
        }

        async function expandSections(unitId) {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(`/api/getSections?unitId=${unitId}`);
                const data = await res.json();
                if (!data.success) { showToast(`è·å–å°èŠ‚å¤±è´¥ï¼š${data.error || ''}`, 'error'); throw new Error(data.error || 'è·å–å°èŠ‚å¤±è´¥'); }
                const tbody = document.getElementById('section-list');
                // å¦‚æœå±•å¼€äº†ä¸åŒçš„å•å…ƒï¼Œåˆ™æ¸…ç©ºä¹‹å‰å·²é€‰æ‹©çš„å°èŠ‚
                const prevUnitId = tbody.dataset.unitId;
                if (prevUnitId && prevUnitId !== unitId) {
                    selectedSections.clear();
                }
                // å±•å¼€å°èŠ‚åï¼Œæ¸…é™¤å•å…ƒçš„å¤é€‰æ¡†ä¸è®°å½•
                selectedlessons.clear();
                document.querySelectorAll('#lesson-list s-checkbox').forEach(cb => { cb.checked = false; });
                const chosen = selectedSections.get(unitId) || new Set();
                tbody.innerHTML = data.sections.map(sec => `
                    <s-tr>
                        <s-td>${sec.id}</s-td>
                        <s-td>${sec.location || sec.name || ''}</s-td>
                        <s-td>${sec.isvisible === 'false' ? 'æœªå¼€æ”¾' : (sec.iscomplete || '')}</s-td>
                        <s-td>
                            <s-checkbox class="section-checkbox" data-unit-id="${unitId}" data-sec-id="${sec.id}" ${chosen.has(sec.id) ? 'checked' : ''}>é€‰æ‹©</s-checkbox>
                        </s-td>
                    </s-tr>
                `).join('');
                // è®°å½•å½“å‰å±•ç¤ºçš„å°èŠ‚æ‰€å±å•å…ƒ
                tbody.dataset.unitId = unitId;
                // å­˜å‚¨è¯¥å•å…ƒå°èŠ‚çš„å…ƒæ•°æ®ï¼Œä¾›æ‘˜è¦å±•ç¤º
                const metaMap = new Map();
                data.sections.forEach(sec => metaMap.set(sec.id, { id: sec.id, name: (sec.location || sec.name || '') }));
                sectionsByUnit.set(unitId, metaMap);
                document.getElementById('section-list-title').textContent = `ï¼ˆå•å…ƒ ${unitId}ï¼‰`;
                document.getElementById('section-list-container').style.display = 'block';
                // æ ¹æ®å½“å‰å‹¾é€‰æƒ…å†µæ›´æ–°è¡¨å¤´â€œå…¨é€‰â€çŠ¶æ€
                const headerAll = document.getElementById('section-select-all');
                if (headerAll) {
                    const cbs = Array.from(document.querySelectorAll('#section-list .section-checkbox'));
                    headerAll.checked = cbs.length > 0 && cbs.every(cb => cb.checked);
                }
                updateSelectionSummary();
            } catch (e) {
                console.warn(e);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function handleTaskStart(taskType) {
            const brainBurst = document.getElementById('start-brain-burst-tooltip');
            const awayFromKeyboard = document.getElementById('start-away-from-keyboard-tooltip');
            // éªŒè¯å¿…å¡«é¡¹
            if (!document.getElementById('freeToUse').checked ||
                !document.getElementById('disclaimer').checked) {
                showToast('è¯·å…ˆåŒæ„ä½¿ç”¨åè®®å’Œå…è´£å£°æ˜ï¼', 'error');
                return;
            }

            // éªŒè¯è‡³å°‘é€‰æ‹©äº†å•å…ƒæˆ–å°èŠ‚
            let hasSections = false;
            selectedSections.forEach((set) => { if (set.size > 0) hasSections = true; });
            if (selectedlessons.size === 0 && !hasSections) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•å…ƒæˆ–å°èŠ‚ï¼', 'error');
                return;
            }

            // è·å–å‚æ•°
            const params = {
                lessonIds: [],
                type: taskType
            };

            // é™„å¸¦å·²é€‰æ‹©çš„å°èŠ‚
            const obj = {};
            selectedSections.forEach((set, unitId) => {
                if (set.size > 0) obj[unitId] = Array.from(set);
            });
            if (Object.keys(obj).length > 0) {
                params.selectedSections = obj;
                // å½“é€‰æ‹©äº†å°èŠ‚æ—¶ï¼Œåªä»¥è¿™äº›å•å…ƒä½œä¸º lessonIdsï¼Œé¿å…è¯¯å¤„ç†æ•´å•å…ƒ
                params.lessonIds = Object.keys(obj);
            } else {
                // æœªé€‰æ‹©å°èŠ‚æ—¶ï¼ŒæŒ‰é€‰ä¸­çš„å•å…ƒæ‰§è¡Œ
                params.lessonIds = Array.from(selectedlessons);
            }

            // ç±»å‹ç‰¹å®šéªŒè¯
            if (taskType === 'brain_burst') {
                const rate = document.getElementById('correct-rate').value;
                if (!validateRate(rate)) {
                    showToast('æ­£ç¡®ç‡æ ¼å¼é”™å•¦ï¼', 'error');
                    return;
                }
                params.rate = rate;
                const offset = document.getElementById('section-offset').value.trim();
                if (offset) {
                    if (!validateTime(offset)) {
                        showToast('å°èŠ‚é”™å¼€æ—¶é—´æ ¼å¼é”™å•¦ï¼', 'error');
                        return;
                    }
                    params.offset = offset;
                }
            } else {
                const time = document.getElementById('idle-time').value;
                if (!validateTime(time)) {
                    showToast('æ—¶é—´æ ¼å¼é”™å•¦ï¼', 'error');
                    return;
                }
                params.time = time;
            }

            // å‘é€è¯·æ±‚
            try {
                document.getElementById('loading').style.display = 'block';
                const res = await fetch('/api/startTask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (!res.ok) {
                    document.getElementById('loading').style.display = 'none';
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
                else {
                    showToast('ä»»åŠ¡å·²å¯åŠ¨ï¼', 'success');
                }
            } catch (error) {
                console.warn('ä»»åŠ¡å¯åŠ¨å¤±è´¥:', error);
                showToast('ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æŸ¥çœ‹æ§åˆ¶å°ï¼', 'error');
                document.getElementById('loading').style.display = 'none';
                return;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
            document.getElementById('allView').scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function reset() {
            await fetch('/api/reset')
                .then(res => res.json())
                .then(data => {
                    console.log(data)
                    document.getElementById('dashboard').style.display = 'none';
                    document.getElementById('onlineStatus').textContent =
                        'åœ¨çº¿çŠ¶æ€ï¼šğŸ”´ æœªç™»å½•';
                });
        }

        function shutdown() {
            shutdownFlag = true;
            try {
                fetch('/api/shutdown');
            }
            catch (error) {
                console.info('è·å–ä¸åˆ°è¿”å›ï¼Œè®¤ä¸ºæ˜¯æœåŠ¡å™¨å·²å…³é—­');
            }
            sleep(2000);
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('onlineStatus').textContent =
                'åœ¨çº¿çŠ¶æ€ï¼šğŸŸ£ å·²å…³é—­ç¨‹åº';
            document.getElementById('current-status').textContent = 'ğŸŸ£ å·²å…³é—­ç¨‹åº';
            document.getElementById('progress-text').textContent = 'å½“å‰è¿è¡ŒçŠ¶æ€ï¼šå·²å…³é—­ç¨‹åºï¼Œç°åœ¨ä½ å¯ä»¥å…³é—­æœ¬é¡µé¢äº†';
            document.getElementById('indetermined-status').style.display = 'none';
            document.getElementById('task-status').style.display = 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            displayCookieAndLastModified();
            const currentYear = new Date().getFullYear();
            const baseYear = 2024;
            const yearSpan = document.getElementById('copyrightYear');

            yearSpan.textContent = currentYear > baseYear
                ? `${baseYear}-${currentYear}`
                : `${baseYear}`;
            if (checkLogon()) {
                loadCourses();
            };
            setInterval(() => {
                if (!shutdownFlag) {
                    updateStatus();
                }
            }, 1000);
        });

        document.getElementById('save-cookie-btn').addEventListener('click', saveCookie);

        document.body.addEventListener('click', (e) => {
            if (e.target.id === 'start-brain-burst') {
                handleTaskStart('brain_burst');
            }
            if (e.target.id === 'start-away-from-keyboard') {
                handleTaskStart('away_from_keyboard');
            }
        });
        // å•å…ƒâ€œå±•å¼€å°èŠ‚â€æŒ‰é’®ç‚¹å‡»
        document.getElementById('lesson-list').addEventListener('click', function (e) {
            const btn = e.target.closest('.expand-sections-btn');
            if (btn) {
                const unitId = btn.dataset.unitId;
                expandSections(unitId);
            }
        });
        // å°èŠ‚å‹¾é€‰
        document.getElementById('section-list').addEventListener('click', function (e) {
            const cb = e.target.closest('.section-checkbox');
            if (!cb) return;
            const unitId = cb.dataset.unitId;
            const secId = cb.dataset.secId;
            // è‹¥æ­¤å‰å·²é€‰æ‹©äº†å•å…ƒï¼Œè€Œå½“å‰å‹¾é€‰å°èŠ‚ -> åˆ‡æ¢ä¸ºâ€œæŒ‰å°èŠ‚â€æ¨¡å¼ï¼Œæ¸…ç©ºå•å…ƒé€‰æ‹©
            if (cb.checked && selectedlessons.size > 0) {
                clearAllUnitSelections();
                showToast('å·²åˆ‡æ¢ä¸ºã€Œå°èŠ‚ã€æ¨¡å¼ï¼šå·²æ¸…é™¤å·²é€‰å•å…ƒ');
            }
            const set = selectedSections.get(unitId) || new Set();
            if (cb.checked) set.add(secId); else set.delete(secId);
            selectedSections.set(unitId, set);
            // æ›´æ–°è¡¨å¤´â€œå…¨é€‰â€å‹¾é€‰çŠ¶æ€
            const headerAll = document.getElementById('section-select-all');
            if (headerAll) {
                const cbs = Array.from(document.querySelectorAll('#section-list .section-checkbox'));
                headerAll.checked = cbs.length > 0 && cbs.every(x => x.checked);
            }
            updateSelectionSummary();
        });
        // è¡¨å¤´â€œå…¨é€‰â€å¤„ç†
        document.body.addEventListener('click', function (e) {
            const headerAll = e.target.closest('#section-select-all');
            if (!headerAll) return;
            const tbody = document.getElementById('section-list');
            const unitId = tbody.dataset.unitId;
            const cbs = Array.from(document.querySelectorAll('#section-list .section-checkbox'));
            const set = new Set(selectedSections.get(unitId) || []);
            // è‹¥æ­¤å‰å·²é€‰æ‹©äº†å•å…ƒï¼Œè€Œå½“å‰æ‰§è¡Œå°èŠ‚â€œå…¨é€‰â€ -> åˆ‡æ¢ä¸ºâ€œæŒ‰å°èŠ‚â€æ¨¡å¼
            if (headerAll.checked && selectedlessons.size > 0) {
                clearAllUnitSelections();
                showToast('å·²åˆ‡æ¢ä¸ºã€Œå°èŠ‚ã€æ¨¡å¼ï¼šå·²æ¸…é™¤å·²é€‰å•å…ƒ');
            }
            cbs.forEach(cb => {
                cb.checked = headerAll.checked;
                const secId = cb.dataset.secId;
                if (headerAll.checked) set.add(secId); else set.delete(secId);
            });
            selectedSections.set(unitId, set);
            updateSelectionSummary();
        });
        document.getElementById('course-list').addEventListener('click', function (e) {
            const btn = e.target.closest('.course-select-btn');
            if (btn) selectCourse(btn.dataset.courseId);
        });

        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('shutdown').addEventListener('click', shutdown);

    </script>
</body>

</html>