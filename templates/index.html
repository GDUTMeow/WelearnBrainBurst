<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>WelearnBrainBurst | GamerNoTitle</title>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            -webkit-text-size-adjust: none;
        }

        :not(:defined) {
            display: none;
        }

        .status-card {
            margin: 16px;
            padding: 16px;
            background: var(--md-sys-color-surface-container);
            border-radius: 12px;
        }
    </style>
    <link rel="stylesheet" href="/static/css/sober-theme.css">
</head>

<body>
    <s-page theme="auto">
        <!-- ä¾§è¾¹å¯¼èˆª -->
        <s-drawer>
            <div slot="start" style="width: auto;">
                <s-navigation mode="rail" onchange="handleNavChange(event)">
                    <s-icon-button slot="start" type="filled-tonal">
                        <img src="/static/img/cat.svg" alt="Logo" style="width: 40px; height: 40px;">
                    </s-icon-button>

                    <s-navigation-item selected="true" data-page="dashboard">
                        <svg slot="icon" viewBox="0 -960 960 960">
                            <path
                                d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />
                        </svg>
                        <div slot="text">æ§åˆ¶é¢æ¿</div>
                    </s-navigation-item>

                    <s-navigation-item id="shutdown">
                        <svg slot="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path
                                d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z">
                            </path>
                        </svg>
                        <div slot="text">é€€å‡ºåŠ©æ‰‹</div>
                    </s-navigation-item>
                    <div slot="end" style="display: flex;align-items: flex-end; padding: 16px 0;">
                        <s-dialog>
                            <s-icon-button type="outlined" slot="trigger">
                                <svg viewBox="0 -960 960 960">
                                    <path
                                        d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z">
                                    </path>
                                </svg>
                            </s-icon-button>
                            <div slot="headline">å…³äº</div>
                            <div slot="text">
                                <h4>WelearnBrainBurst</h4>
                                <p>
                                    WelearnBrainBurst æ˜¯ä¸€ä¸ª WELearn åŠ©æ‰‹ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·è½»æ¾åœ°ä½¿ç”¨ WELearnï¼ŒåŒæ—¶æä¾›ä¸€äº›**é¢å¤–**çš„å®ç”¨åŠŸèƒ½ã€‚
                                </p>
                                <h4>å…è´£å£°æ˜</h4>
                                <p>
                                    æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚
                                </p>
                                <s-divider></s-divider>
                                <p>
                                    Â© 2024
                                    <a href="https://github.com/GamerNoTitle">GamerNoTitle</a>. All
                                    rights reserved.
                                </p>
                            </div>
                            <s-button type="text" slot="action"> å…³é—­ </s-button>
                        </s-dialog>
                    </div>

                </s-navigation>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <s-appbar>
                <s-icon-button slot="navigation" onclick="document.querySelector('s-drawer').toggle()">
                    <s-icon name="menu"></s-icon>
                </s-icon-button>
                <div slot="headline">WelearnBrainBurst</div>
            </s-appbar>

            <s-linear-progress indeterminate="true" id="loading" style="display: none;"></s-linear-progress>

            <!-- æ§åˆ¶é¢æ¿ -->
            <s-scroll-view>
                <main style="display: block; margin: 24px; margin-left: 15%; max-width: 70%;">
                    <s-card style="display: block;
                    padding: 24px;
                    width: 100%;
                    max-width: 100%;
                    margin-top: 24px;">
                        <div slot="headline">è´¦å·ç®¡ç†</div>
                        <div slot="text">
                            <s-text-field style="display: grid; width: auto; margin-bottom: 24px; margin-top: 24px;"
                                label="Cookie" name="cookie-input" id="cookie-input"></s-text-field>
                            <div align="right">
                                <p id="lastModified">ä¸Šæ¬¡ä¿å­˜ï¼šæœªçŸ¥</p>
                                <p id="onlineStatus">åœ¨çº¿çŠ¶æ€</p>
                                <s-button id="save-cookie-btn">ä¿å­˜ Cookie å¹¶ç™»å½•</s-button>
                            </div>
                        </div>
                    </s-card>

                    <s-card style="display: none;
                    padding: 24px;
                    width: 100%;
                    max-width: 100%;
                    margin-top: 24px;" id="dashboard">
                        <div slot="headline" id="welcomeMessage"></div>
                        <div slot="text">
                            <s-table
                                style="max-width: 100%; width: 100%; margin-top: 24px; margin-bottom: 24px; text-align: center;">
                                <s-thead>
                                    <s-tr>
                                        <s-th>è¯¾ç¨‹ç¼–å·</s-th>
                                        <s-th>è¯¾ç¨‹åç§°</s-th>
                                        <s-th>å®Œæˆè¿›åº¦</s-th>
                                        <s-th>æ“ä½œ</s-th>
                                    </s-tr>
                                </s-thead>
                                <s-tbody id="course-list">
                                    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
                                </s-tbody>
                            </s-table>
                            <div id="course-list-container" style="display: none;">
                                <s-divider> å•å…ƒåˆ—è¡¨ </s-divider>
                                <s-table
                                    style="max-width: 100%; width: 100%; margin-top: 24px; margin-bottom: 24px; text-align: center;">
                                    <s-thead>
                                        <s-tr>
                                            <s-th>å•å…ƒç¼–å·</s-th>
                                            <s-th>è¯¾ç¨‹åç§°</s-th>
                                            <s-th>å¼€æ”¾çŠ¶æ€</s-th>
                                            <s-th>é€‰æ‹©</s-th>
                                        </s-tr>
                                    </s-thead>
                                    <s-tbody id="lesson-list">
                                        <!-- å•å…ƒåˆ—è¡¨ -->
                                    </s-tbody>
                                </s-table>
                            </div>
                            <div id='params-setup' style="display: none;">
                                <s-divider> è¯¾ç¨‹å‚æ•°è®¾ç½® </s-divider>
                                <s-text-field style="display: grid; width: auto; margin-top: 24px; margin-bottom: 24px;"
                                    label="æ­£ç¡®ç‡" id="correct-rate"></s-text-field>
                                <s-text-field style="display: grid; width: auto; margin-top: 24px; margin-bottom: 24px;"
                                    label="æŒ‚æœºæ—¶é—´" id="idle-time"></s-text-field>
                                <div align="center">
                                    <p>æ­£ç¡®ç‡è¡¨ç¤ºå•å…ƒçš„æ¯ä¸€èŠ‚çš„æ­£ç¡®ç‡åº”è¯¥ä¸ºå¤šå°‘ï¼Œå¯ä»¥æ˜¯ç¡®åˆ‡çš„æ•°å€¼ä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼Œä¾‹å¦‚ 98 è¡¨ç¤º 98% æ­£ç¡®ç‡ï¼Œ98-100 è¡¨ç¤º 98%-100% æ­£ç¡®ç‡ä¹‹é—´éšæœº
                                    </p>
                                    <p>æŒ‚æœºæ—¶é—´è¡¨ç¤ºå•å…ƒçš„æ¯ä¸€èŠ‚è¦æŒ‚æœºå¤šä¹…ï¼Œå¯ä»¥æ˜¯ç¡®åˆ‡çš„æ•°å€¼ä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼Œä¾‹å¦‚ 300 è¡¨ç¤ºæ¯ä¸€èŠ‚éƒ½æŒ‚æœº 5 åˆ†é’Ÿï¼Œ180-300 è¡¨ç¤ºæ¯ä¸€èŠ‚æŒ‚æœº 180 ç§’åˆ° 300
                                        ç§’ä¸ç­‰çš„æ—¶é—´</p>
                                </div>
                                <div align="right" style="margin-top: 24px;">
                                    <s-checkbox id="freeToUse">
                                        <b>æˆ‘åŒæ„ï¼šæœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿ</b>
                                    </s-checkbox>
                                    <br>
                                    <s-checkbox id="disclaimer">
                                        <b>æˆ‘åŒæ„ï¼šä½¿ç”¨æœ¬é¡¹ç›®é€ æˆçš„åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ï¼Œä½œè€…ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»</b>
                                    </s-checkbox>
                                    <br>
                                    <s-tooltip style="margin-right: 24px; margin-top: 24px;">è®°å¾—å…ˆè®¾ç½®å¥½æ­£ç¡®ç‡ï¼ï¼
                                        <s-button id="start-brain-burst" slot="trigger">
                                            å¼€å§‹åˆ·è¯¾ï¼
                                        </s-button>
                                    </s-tooltip>
                                    <s-tooltip style="margin-top: 24px;">è®°å¾—å…ˆè®¾ç½®å¥½æŒ‚æœºæ—¶é—´ï¼ï¼
                                        <s-button id="start-away-from-keyboard" slot="trigger">
                                            å¼€å§‹æŒ‚æœºï¼
                                        </s-button>
                                    </s-tooltip>
                                </div>
                            </div>
                        </div>
                    </s-card>



                </main>
            </s-scroll-view>
        </s-drawer>
    </s-page>

    <script src="https://unpkg.com/sober@1.0.6/dist/sober.min.js"></script>
    <script>
        let autoRefreshInterval = null;
        let selectedlessons = new Set(); // å­˜å‚¨é€‰ä¸­çš„å•å…ƒID

        // æ·»åŠ /ç§»é™¤å•å…ƒID
        function addlesson(lessonId) {
            const checkbox = document.querySelector(`s-checkbox[onchange*="${lessonId}"]`);
            if (checkbox.checked) {
                selectedlessons.add(lessonId);
            } else {
                selectedlessons.delete(lessonId);
            }
        }

        // éªŒè¯æ­£ç¡®ç‡æ ¼å¼ï¼ˆ0-100 æˆ– A-Bï¼‰
        function validateRate(input) {
            if (/^\d+$/.test(input)) {
                const num = parseInt(input);
                return num >= 0 && num <= 100;
            }
            if (/^\d+-\d+$/.test(input)) {
                const [a, b] = input.split('-').map(Number);
                return a >= 0 && b <= 100 && a < b;
            }
            return false;
        }

        // éªŒè¯æ—¶é—´æ ¼å¼ï¼ˆæ­£æ•´æ•°æˆ– A-Bï¼‰
        function validateTime(input) {
            if (/^\d+$/.test(input)) {
                return parseInt(input) > 0;
            }
            if (/^\d+-\d+$/.test(input)) {
                const [a, b] = input.split('-').map(Number);
                return a > 0 && b > 0 && a < b;
            }
            return false;
        }

        // é¡µé¢å¯¼èˆªå¤„ç†
        function handleNavChange(event) {
            const pages = ['dashboard', 'courses', 'settings'];
            pages.forEach(page => {
                document.getElementById(page).style.display =
                    event.target.selectedIndex === pages.indexOf(page) ? 'block' : 'none';
            });
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        async function updateStatus() {
            try {
                const res = await fetch('/api/getStatus');
                const { success, status, progress } = await res.json();

                if (success) {
                    document.getElementById('current-status').textContent = status;
                    document.getElementById('task-progress').value =
                        progress.total > 0 ? (progress.current / progress.total) * 100 : 0;
                    document.getElementById('progress-text').textContent =
                        `${progress.current}/${progress.total}`;
                }
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }

        // è·å–æ—¥å¿—
        async function fetchLogs() {
            const res = await fetch('/api/getLog');
            const { logs } = await res.json();
            const logOutput = document.getElementById('log-output');
            logOutput.textContent = logs;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // å¼€å§‹ä»»åŠ¡
        async function startTask(taskType) {
            const res = await fetch(`/api/${taskType}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ /* å‚æ•° */ })
            });

            if (res.ok) {
                if (!autoRefreshInterval) {
                    autoRefreshInterval = setInterval(async () => {
                        await updateStatus();
                        await fetchLogs();
                    }, 2000);
                }
            }
        }

        // åœæ­¢ä»»åŠ¡
        async function stopTasks() {
            await fetch('/api/stop', { method: 'POST' });
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            await updateStatus();
        }

        // è¯¾ç¨‹åŠ è½½
        async function loadCourses() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch('/api/getCourses');
                const data = await res.json(); // å¿…é¡»åŠ  await
                console.log('æ¥å£å“åº”æ•°æ®:', data); // è°ƒè¯•ç”¨

                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data.courses) {
                    throw new Error("æ¥å£æœªè¿”å› courses å­—æ®µ");
                }

                const { courses, cid, classid, uid } = data;
                const tbody = document.getElementById('course-list');
                // åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ
                tbody.innerHTML = courses.map(course => `
            <s-tr>
                <s-td>${course.cid}</s-td>
                <s-td>${course.name}</s-td>
                <s-td>
                    ${course.per}% 
                    <s-linear-progress 
                        animated="true" 
                        ${course.per ? `value="${course.per}"` : 'indeterminate="true"'}
                    ></s-linear-progress>
                </s-td>
                <s-td>
                    <s-button 
                        type="filled-tonal" 
                        class="course-select-btn" 
                        data-course-id="${course.cid}"
                    >é€‰æ‹©</s-button>
                </s-td>
            </s-tr>
        `).join('');

            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
            }
            document.getElementById('loading').style.display = 'none';
        }
        // Cookieæ“ä½œ
        async function saveCookie() {
            const cookie = document.getElementById('cookie-input').value;
            document.getElementById('loading').style.display = 'block';
            localStorage.setItem('cookie', cookie);
            localStorage.setItem('lastModified', new Date().toLocaleString());
            document.getElementById('lastModified').textContent = `ä¸Šæ¬¡ä¿å­˜ï¼š${localStorage.getItem('lastModified')}`;
            await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cookies: cookie })
            });
            document.getElementById('loading').style.display = 'none';
            checkLogon();
        }

        function displayCookieAndLastModified() {
            const cookie = localStorage.getItem('cookie');
            const lastModified = localStorage.getItem('lastModified');
            if (cookie) {
                document.getElementById('cookie-input').value = cookie;
            }
            if (lastModified) {
                document.getElementById('lastModified').textContent = `ä¸Šæ¬¡ä¿å­˜ï¼š${lastModified}`;
            }
        }

        async function getCurrentStatus() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                return {
                    status: data.status,
                    progress: {
                        current: data.progress?.current || 0,
                        total: data.progress?.total || 0
                    },
                    activeThreads: data.activeThreads || 0
                };
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                return { status: 'error' }; // è¿”å›æ˜ç¡®çš„é”™è¯¯çŠ¶æ€
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function checkLogon() {
            try {
                const currentStatus = await getCurrentStatus(); // ä½¿ç”¨ await è§£æ Promise
                console.log('å½“å‰çŠ¶æ€:', currentStatus);

                if (currentStatus.status !== 'nologon') {
                    document.getElementById('dashboard').style.display = 'block';
                    const userRes = await fetch('/api/getUserInfo');
                    const userData = await userRes.json();

                    document.getElementById('welcomeMessage').textContent =
                        `æ¬¢è¿å›æ¥ï¼Œ${userData.name} (${userData.student_id})ï¼`;
                    document.getElementById('onlineStatus').textContent =
                        'åœ¨çº¿çŠ¶æ€ï¼šğŸŸ¢ å·²ç™»å½•';
                    return true;
                } else {
                    document.getElementById('dashboard').style.display = 'none';
                    document.getElementById('onlineStatus').textContent =
                        'åœ¨çº¿çŠ¶æ€ï¼šğŸ”´ æœªç™»å½•';
                    return false;
                }
            } catch (error) {
                console.error('ç™»å½•æ£€æŸ¥å¤±è´¥:', error);
                document.getElementById('onlineStatus').textContent =
                    'åœ¨çº¿çŠ¶æ€ï¼šâšª æ£€æµ‹å¼‚å¸¸';
                return false;
            }
        }
        async function selectCourse(cid) {
            document.getElementById('loading').style.display = 'block';
            await fetch('/api/getLessons?cid=' + cid)
                .then(res => res.json())
                .then(data => {
                    console.log(data)
                    const tbody = document.getElementById('lesson-list');
                    selectedlessons.clear();
                    tbody.innerHTML = data.lessons.map(lesson => `
        <s-tr>
          <s-td>${lesson.id}</s-td>
          <s-td>${lesson.name}</s-td>
          <s-td>${lesson.visible ? "å·²å¼€æ”¾" : "æœªå¼€æ”¾"}</s-td>
          <s-td>
            <s-checkbox onchange=addlesson("${lesson.id}")>æˆ‘è¦åˆ·è¿™ä¸ªå•å…ƒï¼</s-checkbox>
          </s-td>
        </s-tr>
                    `).join('');
                });
            document.getElementById('loading').style.display = 'none';
            document.getElementById('course-list-container').style.display = 'block';
            document.getElementById('params-setup').style.display = 'block';
        }

        async function handleTaskStart(taskType) {
            // éªŒè¯å¿…å¡«é¡¹
            if (!document.getElementById('freeToUse').checked ||
                !document.getElementById('disclaimer').checked) {
                alert('è¯·å…ˆåŒæ„å…è´£å£°æ˜ï¼');
                return;
            }

            // éªŒè¯å•å…ƒé€‰æ‹©
            if (selectedlessons.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•å…ƒï¼');
                return;
            }

            // è·å–å‚æ•°
            const params = {
                lessonIds: Array.from(selectedlessons),
                type: taskType
            };

            // ç±»å‹ç‰¹å®šéªŒè¯
            if (taskType === 'brain_burst') {
                const rate = document.getElementById('correct-rate').value;
                if (!validateRate(rate)) {
                    alert('æ­£ç¡®ç‡æ ¼å¼é”™è¯¯ï¼\nç¤ºä¾‹ï¼š98 æˆ– 95-100');
                    return;
                }
                params.rate = rate;
            } else {
                const time = document.getElementById('idle-time').value;
                if (!validateTime(time)) {
                    alert('æ—¶é—´æ ¼å¼é”™è¯¯ï¼\nç¤ºä¾‹ï¼š300 æˆ– 180-300');
                    return;
                }
                params.time = time;
            }

            // å‘é€è¯·æ±‚
            try {
                document.getElementById('loading').style.display = 'block';
                const res = await fetch('/api/startTask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
                alert('ä»»åŠ¡å·²å¼€å§‹ï¼');
            } catch (error) {
                console.error('ä»»åŠ¡å¯åŠ¨å¤±è´¥:', error);
                alert('ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            displayCookieAndLastModified();
            if (checkLogon()) {
                loadCourses();
            };
            // loadCourses();
            // updateStatus();
            // fetchLogs();
        });

        document.getElementById('save-cookie-btn').addEventListener('click', saveCookie);

        document.getElementById('start-brain-burst').addEventListener('click', () =>
            handleTaskStart('brain_burst'));

        document.getElementById('start-away-from-keyboard').addEventListener('click', () =>
            handleTaskStart('away_from_keyboard'));

        document.getElementById('course-list').addEventListener('click', function (e) {
            const btn = e.target.closest('.course-select-btn');
            if (btn) selectCourse(btn.dataset.courseId);
        });


    </script>
</body>

</html>